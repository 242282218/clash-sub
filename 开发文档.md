# Clash 订阅转换服务 - 开发文档

## 项目概述

一个完全自托管的 Clash 订阅转换服务，可以将节点链接（vmess、vless 等）结合配置模板生成 Clash 订阅链接。

## 技术架构

### 方案选择

**推荐方案：Node.js + Express（简单易部署）**
- 后端：Node.js + Express
- 前端：纯 HTML + JavaScript（无需构建）
- 优点：
  - 单一语言栈，易于维护
  - 部署简单，只需 Node.js 环境
  - 资源占用少
  - 可以打包成单个可执行文件

**备选方案：subconverter + sub-web（功能强大）**
- 后端：subconverter（C++）
- 前端：sub-web（Vue.js）
- 优点：
  - 功能完整，社区成熟
  - 性能更好
- 缺点：
  - 部署复杂，需要编译 C++ 代码
  - 维护成本高

## 核心功能模块

### 1. 节点解析模块

支持的协议：
- **vmess://** - VMess 协议（Base64 编码的 JSON）
- **vless://** - VLESS 协议（URL 格式）
- **ss://** - Shadowsocks
- **ssr://** - ShadowsocksR
- **trojan://** - Trojan
- **hysteria2://** - Hysteria2

解析流程：
1. 识别协议类型（通过前缀）
2. Base64 解码（如果需要）
3. 解析参数（JSON 或 URL 参数）
4. 转换为 Clash 格式

### 2. 配置模板处理模块

处理 clash.ini 格式的配置模板：
- 解析 `ruleset=` 规则集定义
- 解析 `custom_proxy_group=` 代理组定义
- 支持正则表达式匹配节点
- 支持 url-test、load-balance、fallback 等策略

### 3. 配置生成模块

生成 Clash YAML 配置：
- 合并节点列表
- 应用规则集
- 生成代理组
- 输出标准 Clash 配置格式

### 4. 订阅服务模块

提供 HTTP API：
- `GET /sub?url=<节点链接>&config=<配置模板>` - 生成订阅
- `GET /config/<id>` - 获取已生成的配置
- 支持配置缓存和更新

## 项目结构

```
clash-sub-converter/
├── backend/                 # 后端服务
│   ├── src/
│   │   ├── parsers/        # 节点解析器
│   │   │   ├── vmess.js
│   │   │   ├── vless.js
│   │   │   ├── ss.js
│   │   │   └── index.js
│   │   ├── config/         # 配置处理
│   │   │   ├── template.js # 模板解析
│   │   │   └── generator.js # 配置生成
│   │   ├── routes/         # API 路由
│   │   │   └── sub.js
│   │   └── app.js          # 主应用
│   ├── package.json
│   └── .env
├── frontend/               # 前端界面
│   ├── index.html
│   ├── style.css
│   └── app.js
├── templates/              # 配置模板目录
│   └── default.ini
├── docker-compose.yml      # Docker 部署
├── Dockerfile
└── README.md
```

## 开发步骤

### 阶段 1：后端核心功能（2-3天）
1. 搭建 Express 服务器
2. 实现 VMess 解析器
3. 实现 VLESS 解析器
4. 实现配置模板解析
5. 实现 Clash 配置生成
6. 实现订阅 API

### 阶段 2：前端界面（1-2天）
1. 创建输入表单（节点链接、配置模板）
2. 实现配置预览
3. 生成订阅链接
4. 添加复制功能

### 阶段 3：部署和优化（1天）
1. Docker 容器化
2. 添加配置缓存
3. 性能优化
4. 文档完善

## 部署方式

### 方式 1：Docker 部署（推荐）

```bash
# 构建镜像
docker build -t clash-sub-converter .

# 运行容器
docker run -d -p 8080:8080 --name clash-sub clash-sub-converter
```

### 方式 2：直接部署

```bash
# 安装依赖
cd backend
npm install

# 启动服务
npm start
```

### 方式 3：PM2 守护进程

```bash
# 安装 PM2
npm install -g pm2

# 启动服务
pm2 start backend/src/app.js --name clash-sub

# 设置开机自启
pm2 startup
pm2 save
```

## 使用流程

1. **访问 Web 界面**：`http://your-server:8080`
2. **输入节点链接**：粘贴 vmess://、vless:// 等链接（每行一个）
3. **选择配置模板**：使用默认模板或上传自定义 clash.ini
4. **生成订阅链接**：点击生成，获得订阅 URL
5. **在 Clash 中订阅**：复制链接到 Clash 客户端

生成的订阅链接格式：
```
http://your-server:8080/sub?nodes=<base64编码的节点>&template=default
```

## 安全建议

1. **使用 HTTPS**：配置 SSL 证书（Let's Encrypt）
2. **访问控制**：添加 API 密钥验证
3. **速率限制**：防止滥用
4. **数据加密**：敏感数据加密存储

## 参考项目

- [tindy2013/subconverter](https://github.com/tindy2013/subconverter) - C++ 实现的订阅转换
- [CareyWang/sub-web](https://github.com/CareyWang/sub-web) - Vue.js 前端界面
- [siiway/urlclash-converter](https://github.com/siiway/urlclash-converter) - 纯前端实现

## 预计开发时间

- **最小可用版本（MVP）**：3-4 天
- **完整功能版本**：5-7 天
- **优化和测试**：1-2 天

**总计：1-2 周**
